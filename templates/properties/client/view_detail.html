{% extends 'properties/base.html' %}
{% load static %}
{% load custom_tags %}
{% load humanize %}

{% block style %}
  <link href="{% static 'properties/main_css/bootstrap.min.css' %}" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'properties/main_css/style.css' %}" />
  <style>
    html {
      scroll-behavior: smooth;
    }
  </style>
{% endblock %}

{% block body %}
  <div data-bs-spy="scroll" data-bs-target="#propertyTabs" data-bs-smooth-scroll="true" tabindex="0">
    <!-- Hero Price Section -->
    <div class="card shadow-sm p-4 mb-4">
  <div class="d-flex justify-content-between flex-wrap">
    <div>
      <h4><strong>{{ property.display_price }}</strong></h4>
      <div class="mt-2">

        {% if property.property_type not in 'land commercial' %}
          <span>{{ property.bhk }}</span>
        {% endif %}

        <span>{{ property.property_type|title }} for {{ property.deal_type|title }}</span>
      </div>
    </div>

    <div class="mt-2 mt-md-0 text-end">
      <button type="button" class="btn btn-success btn-sm me-2"
        data-bs-toggle="modal"
        data-bs-target="#planxModal"
        data-property-id="{{ property.id }}"
        data-contact-url="" contact-owner-btn>
        Contact Owner
      </button>
      {% if is_shortlisted %}
        <button class="btn btn-danger short btn-sm" data-property-id="{{ property.id }}">♥ Shortlisted</button>
      {% else %}
        <button class="btn btn-outline-primary short btn-sm" data-property-id="{{ property.id }}">♡ Shortlist</button>
      {% endif %}
    </div>
  </div>

  <div class="mt-3">

    {# ---- Commercial Property ---- #}
    {% if property.property_type == 'commercial' %}
      <h5 class="mb-1">
        {{ property.business_type|title }}
        {% if property.seats %}• {{ property.seats }} Seats{% endif %}
        {% if property.area %}• {{ property.area }} sq.ft.{% endif %}
      </h5>

    {# ---- Land / Plot ---- #}
    {% elif property.property_type == 'land' %}
      <h5 class="mb-1">
        Plot Area: {{ property.plot_area }} {{ property.area_unit|default:"sq.ft" }}
        {% if property.road_access %}• Road Access: Yes{% endif %}
      </h5>

    {# ---- Residential ---- #}
    {% else %}
      <h5 class="mb-1">
        {{ property.bedrooms }} Bed • {{ property.bathrooms }} Bath • {{ property.area }} {{property.area_unit}}
      </h5>
    {% endif %}

    <p class="text-muted mb-0">{{ property.locality.name }}, {{ property.locality.city.name }}-{{ property.locality.pincode }}</p>
    <span class="badge bg-success me-3 mt-2">{{ property.get_availability_display }}</span>
    {{ property.get_require_display }}
  </div>
</div>


    <!-- Sticky Tabs -->
    <ul id="propertyTabs" class="nav nav-tabs sticky-tabs mb-4">
      <li class="nav-item"><a class="nav-link active" href="#overview">Overview</a></li>
      <li class="nav-item"><a class="nav-link" href="#owner">Owner Details</a></li>
      <li class="nav-item"><a class="nav-link" href="#locality">Explore Locality</a></li>
      <li class="nav-item"><a class="nav-link" href="#similar">Similar Property</a></li>
    </ul>

    <!-- Overview -->
    <section id="overview" class="mb-5">
      <h4 class="mb-3">Overview</h4>
      <div class="row">
        <!-- Left: Carousel -->
        <div class="col-md-7 mb-3">
          <div id="propertyCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              {% if property.images.exists %}
                {% for img in property.images.all %}
                  <div class="carousel-item {% if forloop.first %}active{% endif %}">
                    <img src="{{ img.image.url }}" class="d-block w-100 main-carousel-image" alt="Image {{ forloop.counter }}" />
                  </div>
                {% endfor %}
              {% else %}
                <div class="carousel-item active">
                  <img src="{% static 'properties/images/admin.jpg' %}" class="d-block w-100 main-carousel-image" alt="No image" />
                </div>
              {% endif %}
            </div>
            <button class="carousel-control-prev custom-arrow" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next custom-arrow" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon"></span>
            </button>
          </div>
        </div>

        <!-- Right: Property Details -->
        <div class="col-md-5">
          <div class="card shadow-sm border p-0 mb-3 detail-card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h6 class="fw-bold mb-0">Property Details</h6>
              <small class="text-muted">Posted {{ property.posted_on|date:'d M Y' }}</small>
            </div>
            <div class="card-body p-3">
              <div class="row mb-2">
                <div class="col-6 text-muted small">
                  <i class="bi bi-aspect-ratio me-2 text-primary fs-5"></i>Area
                </div>
                <div class="col-6 fw-semibold text-end">
                  {% if property.property_type not in 'land plot' %}
                    {{ property.area }} sq.ft
                  {% else %}
                    Plot Area: {{ property.area }} sq.ft
                  {% endif %}
                </div>
              </div>

              {% if property.property_type not in 'land plot' and property.property_type != 'commercial' %}
              <div class="row mb-2">
                <div class="col-6 text-muted small">
                  <i class="bi bi-house-door me-2 text-primary fs-5"></i>Configuration
                </div>
                <div class="col-6 fw-semibold text-end">{{ property.bedrooms }} Bed • {{ property.bathrooms }} Bath</div>
              </div>
              {% endif %}

              <div class="row mb-2">
                <div class="col-6 text-muted small">
                  <i class="bi bi-compass me-2 text-info fs-5"></i>Facing
                </div>
                <div class="col-6 fw-semibold text-end">{{ property.facing|capfirst }}</div>
              </div>

              {% if property.property_type not in 'land plot' %}
              <div class="row mb-2">
                <div class="col-6 text-muted small">
                  <i class="bi bi-building me-2 text-secondary fs-5"></i>Total Floors
                </div>
                <div class="col-6 fw-semibold text-end">{{ property.total_floors|default:"--" }}</div>
              </div>

              <div class="row mb-2">
                <div class="col-6 text-muted small">
                  <i class="bi bi-hourglass-split me-2 text-warning fs-5"></i>Property Age
                </div>
                <div class="fw-semibold text-end">{{ property.property_age }} year</div>
              </div>
              {% endif %}

              <div class="row mb-2">
                <div class="col-6 text-muted small">
                  <i class="bi bi-currency-rupee me-2 text-success fs-5"></i>Price
                </div>
                <div class="col-6 fw-bold text-primary text-end">
                  {{ property.display_price }}
                  <div class="small text-muted">
                    {% if property.display_price_per_sqft %}
                      <small>@{{ property.display_price_per_sqft|floatformat:0 }}/sq.ft</small>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- About Property -->
        <h5 class="text-dark mt-3">About Property</h5>
        <p class="text-muted mb-0">
          We have a {{ property.property_type }} for {{ property.deal_type }} in {{ property.locality.name }}, {{ property.locality.city.name }}. 
          Available at {{ property.display_price }}. 
          {% if property.property_type not in 'land plot' and property.property_type != 'commercial' %}
            It has a plot area of {{ property.area }} sq.ft, {{ property.bedrooms }} bedrooms and {{ property.bathrooms }} baths.
          {% else %}
            Plot Area: {{ property.area }} sq.ft
          {% endif %}
        </p>
      </div>
    </section>

    <hr class="my-4 mt-2">

    <!-- Key Information -->
    <h6 class="fw-bold mb-3">Key Information</h6>
    <div class="d-flex flex-wrap gap-4">
      {% if property.property_type not in 'land plot' %}
        <div><span class="text-muted">Furnishing:</span> <span class="fw-semibold">{{ property.get_furnishing_display }}</span></div>
        <div><span class="text-muted">Property Age:</span> <span class="fw-semibold">{{ property.get_property_age_display }}</span></div>
        <div><span class="text-muted">Floor:</span> <span class="fw-semibold">{{ property.floor_number|default:"--" }} / {{ property.total_floors|default:"--" }}</span></div>
      {% endif %}
      <div><span class="text-muted">Parking:</span> <span class="fw-semibold">{{ property.parking }} space(s)</span></div>
      <div><span class="text-muted">Facing:</span> <span class="fw-semibold">{{ property.get_facing_display|default:"--" }}</span></div>
      <div><span class="text-muted">Listed By:</span> <span class="fw-semibold">{{ property.get_listed_by_display }}</span></div>
    </div>

    <hr class="my-4 mt-2">

    <!-- Features -->
    <h6 class="fw-bold mb-3">Features & Amenities</h6>
    {% if property.features.exists %}
      <ul class="list-unstyled row">
        {% for feature in property.features.all %}
          <li class="col-md-3 col-6 mb-2">
            <i class="bi bi-check-circle text-success me-1"></i> {{ feature.name }}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">No extra features listed.</p>
    {% endif %}


    <hr class="my-4 mt-2">

    <!-- Owner Section -->
    <section id="owner" class="py-1 bg-light">
      <div class="container">
        <div class="row align-items-stretch">
          <!-- Left -->
          <div class="col-md-4">
            <div class="owner-box text-center">
              <h4 class="mb-3 fw-bold text-dark text-muted">Owner Details</h4>
              <div class="owner-avatar"><i class="bi bi-person"></i></div>
              <h6 class="mt-2 mb-0 text-dark">{{ property.owner.get_full_name|default:property.owner.username }}</h6>
              <small class="text-muted d-block mb-3">Owner</small>
              <button type="button" class="btn btn-success btn-sm me-2"
                data-bs-toggle="modal"
                data-bs-target="#planxModal"
                data-property-id="{{ property.id }}"
                data-contact-url="">
                Contact Owner
              </button>
              <p class="mb-0 text-dark">
                <strong>Locality:</strong> {{ property.locality.name }}
              </p>
            </div>
          </div>

          <!-- Right -->
          <div class="col-md-8">
            <div class="enquiry-box">
              <h5 class="mb-3 fw-bold text-dark text-muted">Send enquiry to Owner</h5>
              <form action="{% url 'view_detail' property.id %}" method="post">
                {% csrf_token %}
                <div class="mb-3 d-flex gap-4">
                  <label class="form-label d-block">You are</label>
                  <label><input type="radio" name="buyerType" value="individual" checked /> Individual</label>
                  <label><input type="radio" name="buyerType" value="dealer" /> Dealer</label>
                </div>
                <div class="row g-2 mb-3 w-100">
                  <div class="col-md-6">
                    <input type="text" class="form-control" name="name" placeholder="Your Name" value="{{ request.user.get_full_name|default:request.user.username }}" />
                  </div>
                  <div class="col-md-6">
                    <input type="text" class="form-control" name="phone" placeholder="Phone Number" value="{{ request.user.profile.phone|default:'' }}" />
                  </div>
                </div>
                <div class="mb-3">
                  <textarea class="form-control" rows="3" name="message" placeholder="I am interested in this Property."></textarea>
                </div>
                <div class="form-check mb-3">
                  <input class="form-check-input me-2" type="checkbox" id="agree" />
                  <label class="form-check-label small text-muted" for="agree">
                    I agree to the <a href="{% url 'terms' %}">Terms & Conditions</a> and
                    <a href="{% url 'privacypolicy' %}">Privacy Policy</a>
                  </label>
                </div>
                <button type="submit" class="btn btn-primary w-50">Send Email & SMS</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Explore Locality Section -->
    <section id="locality" class="mb-5 mt-3">
      <div class="container ">
        <div class="card p-4 rate">
          <div class="ratings-section">
            <div class="locality-header d-flex justify-content-between">
              <div>
                <h3>Locality Reviews</h3>
                <small class="text-muted">for {{ property.locality.name }}, {{ property.locality.city.name }}</small>
              </div>
              <a href="{% url 'add_review' property.id %}" class="review-btn">Write Your Review</a>
            </div>
            <div class="locality-container d-flex mt-3">
              <!-- LEFT SIDE -->
              <div class="locality-left me-4">
                <div class="locality-rating text-center mb-3">
                  <h2>{{ avg_rating }}</h2>
                  <div class="locality-stars">
                    {% for i in "12345" %}
                      {% if i|add:"0" <= avg_rating %}
                        <i class="bi bi-star-fill text-warning"></i>
                      {% elif i|add:"-0.5" <= avg_rating %}
                        <i class="bi bi-star-half text-warning"></i>
                      {% else %}
                        <i class="bi bi-star text-warning"></i>
                      {% endif %}
                    {% endfor %}
                  </div>
                  <small>{{ total_reviews }} Total Reviews</small>
                </div>

                <!-- Star breakdown -->
                {% for star in "54321" %}
                  <div class="star-row d-flex align-items-center mb-2">
                    <span class="me-2" style="width: 40px;">{{ star }} ★</span>
                    <div class="star-progress flex-grow-1 me-2" style="height: 10px; background: #eee; border-radius: 4px; overflow: hidden;">
                      <div class="star-progress-fill bg-warning" style="width: {{ star_percent|get_item:star }}%; height: 100%;"></div>
                    </div>
                    <span>{{ star_dict|get_item:star }}</span>
                  </div>
                {% endfor %}
              </div>

              <!-- RIGHT SIDE -->
              <div class="locality-right">
                <h5 class="mb-3">Ratings by Features</h5>
                <div class="features">
                  <div class="feature-item"><i class="bi bi-bus-front"></i><span>Connectivity</span> <small>{{ features.Connectivity }} out of 5</small></div>
                  <div class="feature-item"><i class="bi bi-shield-check"></i><span>Safety</span> <small>{{ features.Safety }} out of 5</small></div>
                  <div class="feature-item"><i class="bi bi-droplet"></i><span>Water Supply</span> <small>{{ features|get_item:"Water Supply" }} out of 5</small></div>
                  <div class="feature-item"><i class="bi bi-lightning-charge"></i><span>Power Supply</span><small>{{ features|get_item:"Power Supply" }} out of 5</small></div>
                  <div class="feature-item"><i class="bi bi-tree"></i><span>Cleanliness</span> <small>{{ features.Cleanliness }} out of 5</small></div>
                </div>
              </div>
            </div>

            <hr class="my-4 mt-2">

            <!-- Recent Reviews Carousel -->
            <div class="container my-4">
  <h5 class="mb-3">Recent Reviews</h5>

  {% if reviews %}
    <div id="reviewCarousel" class="carousel slide" data-bs-ride="carousel">
      <div class="carousel-inner">
        {% for review in reviews %}
          {% if forloop.counter0|divisibleby:3 %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <div class="row">
          {% endif %}

          <div class="col-md-4">
            <div class="card shadow-sm border-0 p-3 mx-0 review-card">
              <h6 class="fw-bold">{{ review.locality }}</h6>
              <p class="mb-2">{{ review.comment }}</p>
              <div class="d-flex align-items-center">
                <div class="avatar-circle me-2">{{ review.user.username|first|upper }}</div>
                <div>
                  <strong>{{ review.user.username }}</strong><br>
                  <small class="text-muted">Tenant (living since {{ review.living_since }}) | {{ review.created_at|date:"M d, Y H:i" }}</small>
                </div>
              </div>
            </div>
          </div>

          {% if forloop.counter|divisibleby:3 or forloop.last %}
              </div>
            </div>
          {% endif %}
        {% endfor %}

        <!-- Read all reviews card -->
        <div class="carousel-item">
          <div class="row">
            <div class="col-md-4">
              <div class="card shadow-sm border-0 p-3 mx-2 d-flex align-items-center justify-content-center review-card">
                <a href="{% url 'all_reviews' property.locality.id %}" class="btn btn-primary">
                  Read All Reviews ({{ reviews.count }})
                </a>
              </div>
            </div>
          </div>
        </div>

      </div>

      <button class="customarrow prev" type="button" data-bs-target="#reviewCarousel" data-bs-slide="prev">‹</button>
      <button class="customarrow next" type="button" data-bs-target="#reviewCarousel" data-bs-slide="next">›</button>
    </div>

  {% else %}
    <!-- No reviews message -->
    <div class="text-center py-4">
      <p class="text-muted mb-2">No reviews yet.</p>
      <a href="{% url 'add_review' property.id %}" class="btn btn-primary">Write your first review</a>
    </div>
  {% endif %}

</div>

      </div>
    </section>

    <!-- Similar Properties -->
     {% if similar_props %}
    <section id="similar" class="mb-5 mt-0">
      <div class="mt-3">
        <h5 class="fw-bold mb-2">Similar Properties</h5>
        <div id="similarCarousel" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner">
            {% for sp in similar_props %}
              {% if forloop.first or forloop.counter0|divisibleby:3 %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                  <div class="d-flex justify-content-start">
              {% endif %}

              <div class="card similar-card me-2">
                {% if sp.images.exists %}
                  <img src="{{ sp.images.first.image.url }}" class="card-img-top similar-img" alt="{{ sp.title }}">
                {% else %}
                  <img src="{% static 'properties/images/admin.jpg' %}" class="card-img-top similar-img" alt="No image">
                {% endif %}
                <div class="card-body p-2">
                  <h6 class="card-title fw-bold text-truncate" title="{{ sp.title }}">{{ sp.title }}</h6>
                  <p class="card-text small text-muted mb-1">
                    {{ sp.area }} sq.ft
                    {% if sp.property_type != 'commercial' %}
                      • {{ sp.bedrooms }} Bed • {{ sp.bathrooms }} Bath
                    {% endif %}
                  </p>
                  <p class="text-primary fw-bold mb-1 small">{{ sp.display_price }}</p>
                  <a href="{% url 'view_detail' sp.id %}" class="btn btn-primary btn-sm w-100">View</a>
                </div>
              </div>

              {% if forloop.counter|divisibleby:3 or forloop.last %}
                  </div>
                </div>
              {% endif %}
            {% empty %}
              <p class="text-muted">No similar properties found.</p>
            {% endfor %}
          </div>

          <button class="carousel-control-prev" type="button" data-bs-target="#similarCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#similarCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
        </div>
      </div>
    </section>
    {% endif %}
      </div>

<!-- Plan Modal -->
<div class="modal fade" id="planxModal" tabindex="-1" aria-labelledby="planxModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content planx-modal-content">
      
      <div class="modal-header planx-modal-header">
        <h5 class="modal-title fw-bold" id="planxModalLabel">Choose a Plan to Unlock Owner Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body planx-modal-body">
{% if not user.is_authenticated %}
<div class="alert alert-warning text-center mb-0">
  Please 
  <button type="button" class="btn btn-link fw-bold p-0" data-bs-toggle="modal" data-bs-target="#authLoginModal">
    login
  </button> 
  to continue with the payment.
</div>
        {% else %}
        <div class="row g-3 justify-content-center">

          <!-- Basic Plan -->
          <div class="col-md-4">
            <div class="planx-card planx-basic">
              <div class="planx-card-body">
                <h5 class="planx-card-title">Basic</h5>
                <p class="planx-card-price">₹49</p>
                <ul class="planx-list">
                  <li>1 Contact Unlock</li>
                  <li>Instant Access</li>
                </ul>
                <button class="planx-btn planx-btn-basic buy-plan-btn" data-plan-id="1" data-plan="49">
                  Buy Now
                </button>
              </div>
            </div>
          </div>

          <!-- Standard Plan -->
          <div class="col-md-4">
            <div class="planx-card planx-standard planx-highlight">
              <div class="planx-badge">Most Popular</div>
              <div class="planx-card-body">
                <h5 class="planx-card-title">Standard</h5>
                <p class="planx-card-price">₹399</p>
                <ul class="planx-list">
                  <li>10 Contacts Unlock</li>
                  <li>Priority Access</li>
                </ul>
                <button class="planx-btn planx-btn-standard buy-plan-btn" data-plan-id="2" data-plan="399">
                  Buy Now
                </button>
              </div>
            </div>
          </div>

          <!-- Premium Plan -->
          <div class="col-md-4">
            <div class="planx-card planx-premium">
              <div class="planx-card-body">
                <h5 class="planx-card-title">Premium</h5>
                <p class="planx-card-price">₹999</p>
                <ul class="planx-list">
                  <li>Unlimited Contacts</li>
                  <li>30 Days Access</li>
                  <li>Best Value</li>
                </ul>
                <button class="planx-btn  buy-plan-btn planx-btn-premium" data-plan-id="3" data-plan="999">
                  Buy Now
                </button>
              </div>
            </div>
          </div>

        </div>
        {% endif %}

      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block js %}
  {% comment %} <script src="{% static 'properties/main_js/bootstrap.bundle.min.js' %}"></script> {% endcomment %}
{{ block.super }}
<script src="{% static 'properties/main_js/payment_integration.js' %}"></script>
  {% endblock %} 
